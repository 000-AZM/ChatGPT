<h2>Chat</h2>
<input id="friendEmailInput" placeholder="Friend's Email" />
<button id="startChatBtn">Start Chat</button>
<div id="chatWindow" style="border:1px solid #ccc; height:200px; overflow:auto; margin-top:10px;"></div>
<form id="messageForm" style="display:none;">
  <input id="messageInput" placeholder="Type a message" />
  <button type="button" id="sendBtn">Send</button>
</form>

<script type="module">
  import { auth, db } from './firebase.js';
  import { collection, query, where, getDocs, doc, addDoc, onSnapshot, orderBy } from 'firebase/firestore';

  let chatId = "", currentUser;

  auth.onAuthStateChanged(user => {
    if (!user) return location = "index.html";
    currentUser = user;
  });

  function generateChatId(uid1, uid2) {
    return [uid1, uid2].sort().join("_");
  }

  document.getElementById("startChatBtn").onclick = async () => {
    const email = document.getElementById("friendEmailInput").value.trim();
    if (!email) return alert("Enter friend's email");

    const usersSnap = await getDocs(query(collection(db, "users"), where("email", "==", email)));
    if (usersSnap.empty) return alert("Friend not found");

    const friendUid = usersSnap.docs[0].id;
    chatId = generateChatId(currentUser.uid, friendUid);

    const chatRef = collection(db, "chats", chatId, "messages");
    const q = query(chatRef, orderBy("time"));

    document.getElementById("chatWindow").innerHTML = "";
    document.getElementById("messageForm").style.display = "flex";

    onSnapshot(q, snap => {
      const win = document.getElementById("chatWindow");
      win.innerHTML = "";
      snap.forEach(docSnap => {
        const msg = docSnap.data();
        const div = document.createElement("div");
        div.className = msg.sender === currentUser.email ? "myMessage" : "friendMessage";
        div.textContent = msg.text;
        win.appendChild(div);
      });
      win.scrollTop = win.scrollHeight;
    });
  };

  document.getElementById("sendBtn").onclick = async () => {
    const text = document.getElementById("messageInput").value.trim();
    if (!text || !chatId) return;
    await addDoc(collection(db, "chats", chatId, "messages"), {
      sender: currentUser.email,
      text,
      time: new Date()
    });
    document.getElementById("messageInput").value = "";
  };
</script>
