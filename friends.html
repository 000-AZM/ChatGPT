<h2>Friends</h2>
<input id="friendEmail" placeholder="Friend Email" />
<button id="addFriendBtn">Add Friend</button>
<ul id="friendList"></ul>

<script type="module">
  import { auth, db } from './firebase.js';
  import { collection, doc, getDoc, getDocs, setDoc, query, where } from 'firebase/firestore';

  const list = document.getElementById("friendList");

  auth.onAuthStateChanged(async user => {
    if (!user) return location = "index.html";

    const friendsRef = collection(db, "users", user.uid, "friends");
    const snap = await getDocs(friendsRef);

    snap.forEach(async friend => {
      const friendData = await getDoc(doc(db, "users", friend.id));
      const li = document.createElement("li");
      li.innerText = friendData.data().username;
      list.appendChild(li);
    });

    document.getElementById("addFriendBtn").onclick = async () => {
      const email = document.getElementById("friendEmail").value.trim();
      if (!email) return alert("Enter email");

      const userSnap = await getDocs(query(collection(db, "users"), where("email", "==", email)));
      if (userSnap.empty) return alert("User not found");

      const friendId = userSnap.docs[0].id;
      await setDoc(doc(db, "users", user.uid, "friends", friendId), {});
      alert("Friend added!");
      location.reload();
    };
  });
</script>
